{"version":3,"file":"extract.js","sourceRoot":"","sources":["../../../../lib/modules/manager/azure-pipelines/extract.ts"],"names":[],"mappings":"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","sourcesContent":["import { load } from 'js-yaml';\nimport { logger } from '../../../logger';\nimport { GitTagsDatasource } from '../../datasource/git-tags';\nimport { getDep } from '../dockerfile/extract';\nimport type { PackageDependency, PackageFile } from '../types';\nimport type { AzurePipelines, Container, Repository } from './types';\n\nexport function extractRepository(\n  repository: Repository\n): PackageDependency | null {\n  if (repository.type !== 'github') {\n    return null;\n  }\n\n  if (!repository.ref?.startsWith('refs/tags/')) {\n    return null;\n  }\n\n  return {\n    autoReplaceStringTemplate: 'refs/tags/{{newValue}}',\n    currentValue: repository.ref.replace('refs/tags/', ''),\n    datasource: GitTagsDatasource.id,\n    depName: repository.name,\n    depType: 'gitTags',\n    packageName: `https://github.com/${repository.name}.git`,\n    replaceString: repository.ref,\n  };\n}\n\nexport function extractContainer(\n  container: Container\n): PackageDependency | null {\n  if (!container.image) {\n    return null;\n  }\n\n  const dep = getDep(container.image);\n  logger.debug(\n    {\n      depName: dep.depName,\n      currentValue: dep.currentValue,\n      currentDigest: dep.currentDigest,\n    },\n    'Azure pipelines docker image'\n  );\n  dep.depType = 'docker';\n\n  return dep;\n}\n\nexport function parseAzurePipelines(\n  content: string,\n  filename: string\n): AzurePipelines | null {\n  let pkg: AzurePipelines | null = null;\n  try {\n    pkg = load(content, { json: true }) as AzurePipelines;\n  } catch (err) /* istanbul ignore next */ {\n    logger.info({ filename, err }, 'Error parsing azure-pipelines content');\n    return null;\n  }\n\n  if (!pkg || !pkg.resources) {\n    return null;\n  }\n\n  pkg.resources.containers = pkg.resources.containers || [];\n  pkg.resources.repositories = pkg.resources.repositories || [];\n\n  return pkg;\n}\n\nexport function extractPackageFile(\n  content: string,\n  filename: string\n): PackageFile | null {\n  logger.trace(`azurePipelines.extractPackageFile(${filename})`);\n  const deps: PackageDependency[] = [];\n\n  const pkg = parseAzurePipelines(content, filename);\n  if (!pkg) {\n    return null;\n  }\n\n  // grab the repositories tags\n  for (const repository of pkg.resources.repositories) {\n    const dep = extractRepository(repository);\n    if (dep) {\n      deps.push(dep);\n    }\n  }\n\n  // grab the containers tags\n  for (const container of pkg.resources.containers) {\n    const dep = extractContainer(container);\n    if (dep) {\n      deps.push(dep);\n    }\n  }\n\n  if (!deps.length) {\n    return null;\n  }\n  return { deps };\n}\n"]}